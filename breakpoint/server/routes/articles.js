// server/routes/articles.js
const express = require("express");
const router = express.Router();
const db = require("../config/db");

console.log("✅ Articles-Routes wurden geladen");

// Artikel abrufen (inkl. Suche)
router.get("/", (req, res) => {
  const search = req.query.search;

  if (search) {
    const sql =
      "SELECT * FROM articles WHERE title LIKE ? ORDER BY created_at DESC";
    db.query(sql, [`%${search}%`], (err, results) => {
      if (err) {
        console.error("❌ Fehler bei Suche:", err);
        return res.status(500).json({ error: err });
      }
      return res.json(results);
    });
  } else {
    console.log("➡ GET /api/articles wurde aufgerufen");
    db.query(
      "SELECT * FROM articles ORDER BY created_at DESC",
      (err, results) => {
        if (err) {
          console.error("❌ Fehler bei Query:", err);
          return res.status(500).json({ error: err });
        }
        res.json(results);
      }
    );
  }
});

// Artikel + erste Seite abrufen
router.get("/:id", (req, res) => {
  const { id } = req.params;

  const articleSql = "SELECT * FROM articles WHERE id = ?";
  db.query(articleSql, [id], (err, articleResult) => {
    if (err) {
      console.error("❌ Fehler beim Abrufen des Artikels:", err);
      return res
        .status(500)
        .json({ error: "Fehler beim Abrufen des Artikels." });
    }

    if (articleResult.length === 0) {
      return res.status(404).json({ error: "Artikel nicht gefunden." });
    }

    const article = articleResult[0];

    const pageSql =
      "SELECT * FROM pages WHERE wikiID = ? ORDER BY tocID ASC LIMIT 1";
    db.query(pageSql, [id], (pageErr, pageResult) => {
      if (pageErr) {
        console.error("❌ Fehler beim Abrufen der Seite:", pageErr);
        return res
          .status(500)
          .json({ error: "Fehler beim Abrufen der Seite." });
      }

      article.firstPageTitle =
        pageResult.length > 0 ? pageResult[0].title : null;
      res.json(article);
    });
  });
});

// Artikel erstellen

const defaultImage =
  "data:image/jpeg;base64,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";

router.post("/", (req, res) => {
  const { title, author_id, category, image_url, description } = req.body;

  if (!title) {
    return res.status(400).json({ error: "Title ist ein Pflichtfeld." });
  }

  const finalImageUrl = image_url || defaultImage;

  const sql =
    "INSERT INTO articles (title, author_id, category, image_url, description, views) VALUES (?, ?, ?, ?, ?, 0)";
  db.query(
    sql,
    [title, author_id, category, finalImageUrl, description],
    (err, result) => {
      if (err) return res.status(500).json({ error: err });

      const newWikiId = result.insertId;

      const pageSql =
        "INSERT INTO pages (wikiID, tocID, title) VALUES (?, 0, 'Home')";
      db.query(pageSql, [newWikiId], (pageErr) => {
        if (pageErr) {
          console.error("❌ Fehler beim Erstellen der Startseite:", pageErr);
          return res.status(500).json({ error: pageErr });
        }

        res.status(201).json({ id: result.insertId });
      });
    }
  );
});

// Views erhöhen
router.post("/:id/view", (req, res) => {
  const articleId = req.params.id;
  const sql = "UPDATE articles SET views = views + 1 WHERE id = ?";
  db.query(sql, [articleId], (err) => {
    if (err) return res.status(500).json({ error: err });
    res.status(200).json({ message: "Views erhöht" });
  });
});

module.exports = router;
